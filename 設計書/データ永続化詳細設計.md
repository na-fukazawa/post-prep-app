# ライブ告知 半自動投稿アプリ データ永続化詳細設計（v1）

## 1. 方針

* 端末ローカルに保存し、クラウド同期は行わない
* 構造化データはローカルDBに保存する
* 画像はアプリ専用ディレクトリにコピーし、パスをDBに保持する

---

## 2. ストレージ構成

### 2.1 ローカルDB

* DB: SQLite（`sqflite` を想定）
* DBファイル名: `post_prep.db`
* 保存先: アプリのドキュメント領域

### 2.2 画像保存

* 保存先: `<app-documents>/images/`
* ファイル名: UUID + 拡張子（例: `a1b2c3d4.jpg`）
* DBには相対パス（`images/a1b2c3d4.jpg`）を保存

---

## 3. テーブル設計

### 3.1 announcements

| カラム | 型 | 必須 | 概要 |
| --- | --- | --- | --- |
| id | TEXT | ○ | UUID |
| title | TEXT | ○ | 告知タイトル |
| body | TEXT | ○ | SNS投稿本文 |
| url | TEXT | - | 関連URL |
| images_json | TEXT | - | 画像パス配列（JSON） |
| targets_json | TEXT | ○ | 投稿対象（JSON: `["x","instagram"]`） |
| hashtags_json | TEXT | - | ハッシュタグ配列（JSON） |
| event_date | TEXT | - | 開催日（YYYY-MM-DD） |
| open_time | TEXT | - | 開場（HH:mm） |
| start_time | TEXT | - | 開演（HH:mm） |
| venue | TEXT | - | 会場 |
| performers_json | TEXT | - | 出演者配列（JSON） |
| ticket_price | INTEGER | - | 料金（円） |
| ticket_url | TEXT | - | 予約URL |
| status | TEXT | ○ | `draft/scheduled/posted/failed` |
| failure_reason | TEXT | - | 投稿失敗理由 |
| publish_at | INTEGER | ○ | 公開日時（epoch ms） |
| notification_id | INTEGER | - | ローカル通知ID |
| created_at | INTEGER | ○ | 作成日時（epoch ms） |
| updated_at | INTEGER | ○ | 更新日時（epoch ms） |

**補足**

* JSONカラムは小規模データ前提で利用する
* 文字列はUTF-8

---

### 3.2 settings

| カラム | 型 | 必須 | 概要 |
| --- | --- | --- | --- |
| key | TEXT | ○ | 設定キー |
| value | TEXT | - | 値（JSON文字列） |

**キー例**

* `notificationsEnabled`: `true/false`
* `defaultTargets`: `["x","instagram"]`
* `defaultHashtags`: `["#live","#gig"]`
* `captionTemplate`: テンプレート本文
* `aiTone`: `exciting/casual/minimal`

---

## 4. CRUD仕様

### 4.1 作成

* 新規作成時に `id` をUUIDで生成
* 画像がある場合は保存ディレクトリへコピーしてパスを保存
* 公開予約時は `notification_id` を払い出し、通知を登録

### 4.2 更新

* `updated_at` を更新
* 公開日時変更時は通知を再登録（旧`notification_id`はキャンセル）
* 画像削除時は該当ファイルも削除

### 4.3 削除

* announcements を削除時に関連画像ファイルも削除
* 設定「全データ削除」はDBを削除し、画像ディレクトリも削除

### 4.4 読み込み

* 一覧: `status` と `publish_at` でソート
* カレンダー: `publish_at` の日付範囲で抽出
* 画像・タグなどの配列はJSONとして復元

---

## 5. ステータス遷移（永続化観点）

* `draft` → `scheduled`（公開予約）
* `scheduled` → `posted`（投稿完了）
* `scheduled`/`draft` → `failed`（共有/外部起動失敗）
* `failed` → `scheduled`（再試行成功）

---

## 6. マイグレーション方針

* DBバージョンを整数で管理（例: v1=1）
* 追加カラムは `ALTER TABLE` で段階的に対応
* 互換性が壊れる変更は新テーブル作成 + 移行

---

## 7. バリデーション（保存時）

* `title` / `body` / `publish_at` / `targets_json` は必須
* `ticket_price` は0以上
* `url` / `ticket_url` はURL形式
* `event_date` / `open_time` / `start_time` は形式チェック

---

以上
